<!DOCTYPE html>
<html>
<head>
    <title>Utah Higher Education Map</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
        }
        #map { 
            height: 100vh; 
            width: 100vw; 
        }
        #stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            min-width: 250px;
        }
        #stats h3 {
            margin-top: 0;
            color: #333;
        }
        .school-stat {
            margin: 10px 0;
            padding: 8px;
            border-left: 4px solid;
            background: #f5f5f5;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>Loading Census Data...</h2>
        <p>This may take a moment...</p>
    </div>
    
    <div id="map"></div>
    
    <div id="stats" class="hidden">
        <h3>Population by Territory</h3>
        <div id="population-data"></div>
        <p style="margin-top: 20px; font-size: 12px; color: #666;">
            Based on 2020 Census Tracts with hybrid assignment
        </p>
    </div>
    
    <!-- Load Turf.js for geometric calculations -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <!-- Load d3-delaunay for Voronoi calculation -->
    <script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>
    
    <!-- Load Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCO_xyZA-1wJkLBHdU1OeP7Sy6Obd0TGoU&callback=initMap" async defer></script>
    
    <script>
        // Your university coordinates and colors
        const universities = [
            { name: "USU", lat: 41.74429949056506, lng: -111.80960833210244, color: "#0033A0" },
            { name: "Snow College", lat: 39.36137388396589, lng: -111.58297041860617, color: "#F47920" },
            { name: "SUU", lat: 37.676573445963854, lng: -113.07130010332827, color: "#C8102E" },
            { name: "U of U", lat: 40.765115542365265, lng: -111.84215574738786, color: "#8B0000" },
            { name: "Utah Tech", lat: 37.1030200380077, lng: -113.56539927451365, color: "#D32F2F" },
            { name: "UVU", lat: 40.27895082884734, lng: -111.71540608973666, color: "#165C34" },
            { name: "Weber State", lat: 41.191486864071116, lng: -111.94404670319685, color: "#4B2E83" },
            { name: "SLCC", lat: 40.68171798034497, lng: -111.9429561670003, color: "#FFB81C" }
        ];

        let voronoiRegions = [];
        let map;

        async function initMap() {
            // Center map on Utah
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 39.3, lng: -111.7 },
                zoom: 7
            });

            // Calculate and draw Voronoi regions
            voronoiRegions = drawVoronoiRegions(map);
            
            // Add markers for each university
            universities.forEach(uni => {
                new google.maps.Marker({
                    position: { lat: uni.lat, lng: uni.lng },
                    map: map,
                    title: uni.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: uni.color,
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 2
                    }
                });
            });

            // Load and process census data
            await loadCensusData();
        }

        function drawVoronoiRegions(map) {
            // Convert lat/lng to points for Voronoi calculation
            const points = universities.map(uni => [uni.lng, uni.lat]);
            
            // Create Delaunay triangulation (Voronoi is its dual)
            const delaunay = d3.Delaunay.from(points);
            
            // Define a bounding box for Utah (approximate)
            const bounds = [-114.5, 37, -109, 42]; // [west, south, east, north]
            const voronoi = delaunay.voronoi(bounds);
            
            const regions = [];
            
            // Draw each Voronoi cell as a polygon
            universities.forEach((uni, i) => {
                const cell = voronoi.cellPolygon(i);
                if (!cell) return;
                
                // Convert Voronoi coordinates back to lat/lng for Google Maps
                const paths = cell.map(point => ({
                    lat: point[1],
                    lng: point[0]
                }));
                
                // Store as Turf polygon for intersection calculations
                const turfPolygon = turf.polygon([[...cell, cell[0]]]);
                regions.push({
                    university: uni.name,
                    color: uni.color,
                    polygon: turfPolygon
                });
                
                // Draw polygon on map
                new google.maps.Polygon({
                    paths: paths,
                    strokeColor: uni.color,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: uni.color,
                    fillOpacity: 0.35,
                    map: map
                });
            });
            
            return regions;
        }

        async function loadCensusData() {
            try {
                const response = await fetch('utah-tracts-2020.geojson');
                const censusData = await response.json();
                
                // Process tracts and calculate populations
                const populations = calculatePopulations(censusData);
                
                // Display results
                displayPopulations(populations);
                
                // Hide loading, show stats
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading census data:', error);
                document.getElementById('loading').innerHTML = 
                    '<h2>Error Loading Data</h2><p>Make sure utah-tracts-2020.geojson is in the same folder as this HTML file.</p>';
            }
        }

        function calculatePopulations(censusData) {
            const populations = {};
            universities.forEach(uni => populations[uni.name] = 0);
            
            let tractsProcessed = 0;
            let tractsSplit = 0;
            
            censusData.features.forEach(feature => {
                const population = feature.properties.POP100 || 0; // Total population field
                if (population === 0) return;
                
                // Convert census tract to Turf polygon
                const tractPolygon = turf.feature(feature.geometry);
                const centroid = turf.centroid(tractPolygon);
                
                // Check which Voronoi region the centroid is in
                let primaryRegion = null;
                for (let region of voronoiRegions) {
                    if (turf.booleanPointInPolygon(centroid, region.polygon)) {
                        primaryRegion = region;
                        break;
                    }
                }
                
                if (!primaryRegion) return;
                
                // Check if tract intersects multiple regions (hybrid approach)
                const intersections = [];
                for (let region of voronoiRegions) {
                    try {
                        const intersection = turf.intersect(tractPolygon, region.polygon);
                        if (intersection) {
                            const area = turf.area(intersection);
                            intersections.push({
                                university: region.university,
                                area: area
                            });
                        }
                    } catch (e) {
                        // Some tracts may have complex geometries that cause issues
                        // Skip intersection calculation for these
                    }
                }
                
                // If only one intersection or intersections failed, assign all to primary
                if (intersections.length <= 1) {
                    populations[primaryRegion.university] += population;
                } else {
                    // Split population based on area proportions
                    const totalArea = intersections.reduce((sum, i) => sum + i.area, 0);
                    intersections.forEach(intersection => {
                        const proportion = intersection.area / totalArea;
                        populations[intersection.university] += Math.round(population * proportion);
                    });
                    tractsSplit++;
                }
                
                tractsProcessed++;
            });
            
            console.log(`Processed ${tractsProcessed} tracts, ${tractsSplit} were split across boundaries`);
            
            return populations;
        }

        function displayPopulations(populations) {
            const container = document.getElementById('population-data');
            
            // Sort by population descending
            const sorted = Object.entries(populations)
                .sort((a, b) => b[1] - a[1])
                .map(([name, pop]) => {
                    const uni = universities.find(u => u.name === name);
                    return { name, pop, color: uni.color };
                });
            
            // Calculate total
            const total = sorted.reduce((sum, item) => sum + item.pop, 0);
            
            // Display each school
            sorted.forEach(item => {
                const percentage = ((item.pop / total) * 100).toFixed(1);
                const div = document.createElement('div');
                div.className = 'school-stat';
                div.style.borderLeftColor = item.color;
                div.innerHTML = `
                    <strong>${item.name}</strong><br>
                    ${item.pop.toLocaleString()} people (${percentage}%)
                `;
                container.appendChild(div);
            });
            
            // Add total
            const totalDiv = document.createElement('div');
            totalDiv.style.marginTop = '15px';
            totalDiv.style.paddingTop = '15px';
            totalDiv.style.borderTop = '2px solid #333';
            totalDiv.innerHTML = `<strong>Total: ${total.toLocaleString()} people</strong>`;
            container.appendChild(totalDiv);
        }
    </script>
</body>
</html>